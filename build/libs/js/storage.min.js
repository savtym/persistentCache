
'use strict';var _slicedToArray=function(){function sliceIterator(arr,i){var _arr=[];var _n=true;var _d=false;var _e=undefined;try{for(var _i=arr[Symbol.iterator](),_s;!(_n=(_s=_i.next()).done);_n=true){_arr.push(_s.value);if(i&&_arr.length===i)break;}}catch(err){_d=true;_e=err;}finally{try{if(!_n&&_i["return"])_i["return"]();}finally{if(_d)throw _e;}}return _arr;}return function(arr,i){if(Array.isArray(arr)){return arr;}else if(Symbol.iterator in Object(arr)){return sliceIterator(arr,i);}else{throw new TypeError("Invalid attempt to destructure non-iterable instance");}};}();var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor);}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor;};}();function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function");}}
var counterRequest=0;var maxMemoryDefault=16384;var Persistent=function(){function Persistent(curId,curMaxSize){_classCallCheck(this,Persistent);this._id=curId;this.maxMemory=curMaxSize||maxMemoryDefault;this._lifeTime={};this.data()||localStorage.setItem(this._id,'{}');}
_createClass(Persistent,[{key:'data',value:function data(key){counterRequest++;if(key){return JSON.parse(localStorage.getItem(this._id))[key];}else{return JSON.parse(localStorage.getItem(this._id));}}},{key:'insert',value:function insert(key,data,sizeData){var freeSize=this.freeMemory;var values=this.data();if(typeof values[key]!=='undefined'&&JSON.stringify(values[key])===JSON.stringify(data)){Storage._setKeyLifeTime(key,sizeData,this._lifeTime);return;}
if(sizeData<freeSize){this._setValuesLocalStorage(key,data,values,sizeData);}else if(sizeData<this._maxMemory){var overwriting=Storage._leastRecentlyUsed(this._lifeTime,sizeData-freeSize);var _values=this.data();var _iteratorNormalCompletion=true;var _didIteratorError=false;var _iteratorError=undefined;try{for(var _iterator=overwriting[Symbol.iterator](),_step;!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=true){var _step$value=_slicedToArray(_step.value,1),_key=_step$value[0];delete this._lifeTime[_key];delete _values[_key];}}catch(err){_didIteratorError=true;_iteratorError=err;}finally{try{if(!_iteratorNormalCompletion&&_iterator.return){_iterator.return();}}finally{if(_didIteratorError){throw _iteratorError;}}}
this._setValuesLocalStorage(key,data,_values,sizeData);}else{throw'Max size Persistent is less than this data';}}},{key:'remove',value:function remove(key){var values=this.data();if(values[key]){delete values[key];counterRequest++;localStorage.setItem(this._id,JSON.stringify(values));}}},{key:'clear',value:function clear(){this._lifeTime={};counterRequest++;localStorage.setItem(this._id,'{}');}},{key:'_setValuesLocalStorage',value:function _setValuesLocalStorage(key,data,values,sizeData){values[key]=data;Storage._setKeyLifeTime(key,sizeData,this._lifeTime);counterRequest++;localStorage.setItem(this._id,JSON.stringify(values));}},{key:'maxMemory',get:function get(){return this._maxMemory;},set:function set(value){value=typeof value==='number'?value:parseInt(value);if(!isNaN(value)&&value>=0){this._maxMemory=value;if(value<this.busyMemory){var overwriting=Storage._leastRecentlyUsed(this._lifeTime,this.busyMemory-value);var values=this.data();var _iteratorNormalCompletion2=true;var _didIteratorError2=false;var _iteratorError2=undefined;try{for(var _iterator2=overwriting[Symbol.iterator](),_step2;!(_iteratorNormalCompletion2=(_step2=_iterator2.next()).done);_iteratorNormalCompletion2=true){var _step2$value=_slicedToArray(_step2.value,1),key=_step2$value[0];delete this._lifeTime[key];delete values[key];}}catch(err){_didIteratorError2=true;_iteratorError2=err;}finally{try{if(!_iteratorNormalCompletion2&&_iterator2.return){_iterator2.return();}}finally{if(_didIteratorError2){throw _iteratorError2;}}}
counterRequest++;localStorage.setItem(this._id,JSON.stringify(values));}}}},{key:'busyMemory',get:function get(){return Storage.sizeOf(localStorage.getItem(this._id));}},{key:'freeMemory',get:function get(){return this._maxMemory-Storage.sizeOf(localStorage.getItem(this._id));}}],[{key:'counterRequest',get:function get(){return counterRequest;}}]);return Persistent;}();'use strict';var _slicedToArray=function(){function sliceIterator(arr,i){var _arr=[];var _n=true;var _d=false;var _e=undefined;try{for(var _i=arr[Symbol.iterator](),_s;!(_n=(_s=_i.next()).done);_n=true){_arr.push(_s.value);if(i&&_arr.length===i)break;}}catch(err){_d=true;_e=err;}finally{try{if(!_n&&_i["return"])_i["return"]();}finally{if(_d)throw _e;}}return _arr;}return function(arr,i){if(Array.isArray(arr)){return arr;}else if(Symbol.iterator in Object(arr)){return sliceIterator(arr,i);}else{throw new TypeError("Invalid attempt to destructure non-iterable instance");}};}();var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor);}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor;};}();function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function");}}
var maxMemoryDefault=16384;var RAM=function(){function RAM(curMaxSize){_classCallCheck(this,RAM);this.maxMemory=curMaxSize||maxMemoryDefault;this._busyMemory=0;this._lifeTime={};this._data={};}
_createClass(RAM,[{key:'data',value:function data(key){if(key){return this._data[key];}else{return this._data;}}},{key:'insert',value:function insert(key,data,sizeData){var freeSize=this.freeMemory;if(sizeData<freeSize){if(this._data[key]){this._data[key]={};}
this._data[key]=data;this._busyMemory+=sizeData;Storage._setKeyLifeTime(key,sizeData,this._lifeTime);}else if(sizeData<this.maxMemory){var overwriting=Storage._leastRecentlyUsed(this._lifeTime,sizeData-freeSize);var _iteratorNormalCompletion=true;var _didIteratorError=false;var _iteratorError=undefined;try{for(var _iterator=overwriting[Symbol.iterator](),_step;!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=true){var _step$value=_slicedToArray(_step.value,2),_key=_step$value[0],obj=_step$value[1];this._busyMemory-=obj.size;delete this._lifeTime[_key];delete this._data[_key];}}catch(err){_didIteratorError=true;_iteratorError=err;}finally{try{if(!_iteratorNormalCompletion&&_iterator.return){_iterator.return();}}finally{if(_didIteratorError){throw _iteratorError;}}}}else{throw'Max size RAM is less than this data';}}},{key:'remove',value:function remove(key){if(this._data[key]){this._busyMemory-=this._lifeTime[key].size;delete this._data[key];}}},{key:'clear',value:function clear(){this._busyMemory=0;this._lifeTime={};this._data={};}},{key:'maxMemory',get:function get(){return this._maxMemory;},set:function set(value){value=typeof value==='number'?value:parseInt(value);if(!isNaN(value)&&value>=0){this._maxMemory=value;if(value<this.busyMemory){var overwriting=Storage._leastRecentlyUsed(this._lifeTime,this.busyMemory-value);var _iteratorNormalCompletion2=true;var _didIteratorError2=false;var _iteratorError2=undefined;try{for(var _iterator2=overwriting[Symbol.iterator](),_step2;!(_iteratorNormalCompletion2=(_step2=_iterator2.next()).done);_iteratorNormalCompletion2=true){var _step2$value=_slicedToArray(_step2.value,2),key=_step2$value[0],obj=_step2$value[1];this._busyMemory-=obj.size;delete this._lifeTime[key];delete this._data[key];}}catch(err){_didIteratorError2=true;_iteratorError2=err;}finally{try{if(!_iteratorNormalCompletion2&&_iterator2.return){_iterator2.return();}}finally{if(_didIteratorError2){throw _iteratorError2;}}}}}}},{key:'busyMemory',get:function get(){return this._busyMemory;}},{key:'freeMemory',get:function get(){return this.maxMemory-this._busyMemory;}}]);return RAM;}();'use strict';Object.defineProperty(exports,"__esModule",{value:true});var _slicedToArray=function(){function sliceIterator(arr,i){var _arr=[];var _n=true;var _d=false;var _e=undefined;try{for(var _i=arr[Symbol.iterator](),_s;!(_n=(_s=_i.next()).done);_n=true){_arr.push(_s.value);if(i&&_arr.length===i)break;}}catch(err){_d=true;_e=err;}finally{try{if(!_n&&_i["return"])_i["return"]();}finally{if(_d)throw _e;}}return _arr;}return function(arr,i){if(Array.isArray(arr)){return arr;}else if(Symbol.iterator in Object(arr)){return sliceIterator(arr,i);}else{throw new TypeError("Invalid attempt to destructure non-iterable instance");}};}();var _typeof=typeof Symbol==="function"&&typeof Symbol.iterator==="symbol"?function(obj){return typeof obj;}:function(obj){return obj&&typeof Symbol==="function"&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj;};var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor);}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor;};}();function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function");}}
var globalSizeLocal=5242880;var idMemory=1;var storage={};var Storage=function(){function Storage(_ref){var sizeRAM=_ref.sizeRAM,sizeLocal=_ref.sizeLocal,_ref$id=_ref.id,id=_ref$id===undefined?idMemory:_ref$id;_classCallCheck(this,Storage);if(Storage.freeMemoryLocal<sizeLocal){throw'Memory local is full, remove cache!';}
this._id=id;this._ram=new RAM(sizeRAM);this._persistent=new Persistent(id,sizeLocal);storage[id]=this;if(idMemory===id){idMemory++;}}
_createClass(Storage,[{key:'data',value:function data(key){var result=void 0;if(typeof key!=='undefined'){key=typeof key==='string'?key:key.toString();result=this.ram.data(key);if(typeof result==='undefined'){result=this.persistent.data(key);if(typeof result!=='undefined'){this.ram.insert(key,result,Storage.sizeOf(result));}}}else{result={ram:this.ram.data(),persistent:this.persistent.data()};}
return result;}},{key:'insert',value:function insert(key,data){if(typeof data==='undefined'){throw'Data is undefined';}
key=typeof key==='string'?key:key.toString();this.ram.insert(key,data,Storage.sizeOf(data));this.persistent.insert(key,data,Storage.sizeOf(JSON.stringify({key:data})));}},{key:'remove',value:function remove(key){if(typeof key==='undefined'){throw'Key is undefined';}
key=typeof key==='string'?key:key.toString();this.ram.remove(key);this.persistent.remove(key);}},{key:'clear',value:function clear(){this._ram.clear();this._persistent.clear();}},{key:'id',get:function get(){return this._id;}},{key:'ram',get:function get(){return this._ram;}},{key:'persistent',get:function get(){return this._persistent;}}],[{key:'clearById',value:function clearById(id){if(typeof id!=='number'&&typeof id!=='string'){throw'Id is not string or number';}
if(storage[id]){storage[id]._ram.clear();storage[id]._persistent.clear();}else{localStorage.removeItem(id);}}},{key:'removeById',value:function removeById(id){if(typeof id!=='number'&&typeof id!=='string'){throw'Id is not string or number';}
if(storage[id]){storage[id].clear();storage[id]._ram=null;storage[id]._persistent=null;delete storage[id];}else{localStorage.removeItem(id);}}},{key:'remove',value:function remove(){var _iteratorNormalCompletion=true;var _didIteratorError=false;var _iteratorError=undefined;try{for(var _iterator=storage[Symbol.iterator](),_step;!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=true){var cache=_step.value;cache.clear();cache._ram=null;cache._persistent=null;cache=null;}}catch(err){_didIteratorError=true;_iteratorError=err;}finally{try{if(!_iteratorNormalCompletion&&_iterator.return){_iterator.return();}}finally{if(_didIteratorError){throw _iteratorError;}}}
storage=[];localStorage.clear();}},{key:'sizeOf',value:function sizeOf(obj){var bytes=0;if(obj!==null&&obj!==undefined){switch(typeof obj==='undefined'?'undefined':_typeof(obj)){case'number':bytes+=8;break;case'string':bytes+=obj.length*2;break;case'boolean':bytes+=4;break;case'object':var objClass=Object.prototype.toString.call(obj).slice(8,-1);if(objClass==='Object'||objClass==='Array'){for(var key in obj){if(!obj.hasOwnProperty(key)){continue;}
bytes+=Storage.sizeOf(obj[key]);}}else{bytes+=JSON.stringify(obj).length*2;}
break;}}
return bytes;}},{key:'_setKeyLifeTime',value:function _setKeyLifeTime(key,sizeData,lifeTime){lifeTime[key]={size:sizeData,time:new Date().getTime()};}},{key:'_leastRecentlyUsed',value:function _leastRecentlyUsed(lifeTime,needSize){var result=[];var sortable=[];var curSizeFree=0;for(var key in lifeTime){sortable.push([key,lifeTime[key]]);}
sortable.sort(function(a,b){return a[1].time-b[1].time;});var _iteratorNormalCompletion2=true;var _didIteratorError2=false;var _iteratorError2=undefined;try{for(var _iterator2=sortable[Symbol.iterator](),_step2;!(_iteratorNormalCompletion2=(_step2=_iterator2.next()).done);_iteratorNormalCompletion2=true){var _step2$value=_slicedToArray(_step2.value,2),_key=_step2$value[0],obj=_step2$value[1];result.push([_key,obj]);curSizeFree+=obj.size;if(curSizeFree>=needSize){break;}}}catch(err){_didIteratorError2=true;_iteratorError2=err;}finally{try{if(!_iteratorNormalCompletion2&&_iterator2.return){_iterator2.return();}}finally{if(_didIteratorError2){throw _iteratorError2;}}}
return result;}},{key:'maxMemoryLocal',get:function get(){return globalSizeLocal;}},{key:'freeMemoryLocal',get:function get(){return globalSizeLocal-Storage.sizeOf(localStorage);}},{key:'counterRequest',get:function get(){return Persistent.counterRequest;}}]);return Storage;}();exports.default=Storage;